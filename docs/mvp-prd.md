# 17-track 查询微服务 MVP PRD

## 1. 背景与目标
跨境业务系统需要一个可以直接复用的 17-track 查询微服务，以便不同系统在不关注底层 API 的情况下查询运单、获取状态更新并接收外部推送。MVP 目标是在最短时间内提供一个可部署的 Java 微服务，使用 MySQL + Redis 存储/缓存轨迹数据，开放标准 REST API 供其他系统调用，无需任何登录或权限模块。

## 2. 业务范围
- **单号查询**：对外提供按单号查询的 REST 接口，聚合 Redis 缓存和 17-track 实时结果。
- **状态监听与更新**：周期性刷新存量单号，并将最新状态落库、写缓存和触发消息通知。
- **运单号接入**：支持外部系统通过接口上传单号，以及监听外部推送（webhook）将单号写入处理队列。
- **接口暴露**：所有能力通过 REST API 或 webhook 注册完成，确保其他微服务可快速集成。

不包含：后台页面、账号系统、复杂任务编排、报表分析。

## 3. 主要使用者
- **对接系统开发者**：调用查询接口或上传单号，不需要了解 17-track API 细节。
- **运维/平台服务**：配置刷新频率、查看健康状况，确保刷新任务稳定执行。

## 4. 功能需求
1. **查询接口**
   - `GET /api/trackings/{trackingNo}` 返回最新状态、更新时间、轨迹摘要。
   - 支持批量查询 `POST /api/trackings/query`（<= 50 条）。
   - 优先读 Redis 缓存，未命中则请求 17-track API，将结果写入 MySQL + Redis。
2. **单号接入**
   - `POST /api/trackings` 接收单号或批次（含来源字段），写入待刷新队列。
   - Webhook 监听端点 `POST /api/webhooks/17track` 校验签名后写队列。
   - 支持手动上传文件（CSV）并拆分入队，由调用方提供文件 URL。
3. **状态刷新**
   - 定时任务扫描待刷新单号，调用 17-track API 并更新 MySQL/Redis。
   - 去重锁：Redis 记录刷新中的单号，防止重复调用。
   - 状态变更后触发事件（例如 Kafka/Redis Stream）供下游消费。
4. **配置与监控**
   - 通过配置文件或 `application.yml` 设置 API Key、刷新频率、重试次数。
   - 暴露 `GET /actuator/health`、`/metrics` 供监控。

## 5. 非功能需求
- **性能**：缓存命中查询 < 500ms，直连 17-track < 3s（含重试）。
- **可靠性**：失败自动重试 3 次；刷新任务支持断点重跑。
- **可扩展性**：接口幂等、可水平扩展；Redis 用于分布式锁与缓存。
- **安全**：以 IP 白名单或网关层面控制访问，接口本身无需鉴权。

## 6. 技术实现要点
- **后端**：Java 17 + Spring Boot 3，使用 WebFlux/RestTemplate 调用 17-track API。
- **数据库**：MySQL 8 存储单号、最新状态、轨迹摘要、刷新时间；关键索引：tracking_no、updated_at。
- **缓存**：Redis 保存最新状态 JSON、刷新锁以及待处理队列（List/Stream）。
- **异步处理**：Spring Scheduler + TaskExecutor，必要时集成消息队列以通知下游。
- **接口契约**：使用 OpenAPI 3 描述，方便其他系统生成 SDK。

## 7. 成功指标
- 95% 查询命中缓存或最近 10 分钟内刷新结果。
- 单号接入后 5 分钟内完成首轮状态拉取。
- 服务上线首周无 P1 故障，刷新任务成功率 ≥ 99%。
# 查单后台 MVP PRD

## 1. 背景与目标
17-track API 接入服务需要一个供客服与运营人员使用的查单后台，以统一管理跨境物流单号的查询、同步与异常处理。MVP 的目标是在 2 周内交付一个可用的后台系统，支持 Java 开发栈、MySQL 数据库和 Redis 缓存，确保客服可以快速检索单号、查看实时状态并触发刷新。

## 2. 业务范围
- **单号查询**：接入 17-track API，按单号或批量导入查询物流状态。
- **异常处理**：标记异常单、添加备注、分配处理人。
- **同步控制**：手动触发刷新、设置自动刷新策略。
- **账号管理（最简）**：仅提供内部账号登录及权限控制，初期只分管理员与客服两种角色。

不包含：计费、外部客户访问、复杂报表。

## 3. 用户画像
- **客服专员**：需要高效搜索与查看单号状态，并对异常单做记录。
- **运营主管**: 关注异常分布与刷新情况，配置刷新策略与权限。

## 4. 功能需求
1. **登录与权限**
   - SSO 或内部账号密码登录。
   - 角色：管理员、客服；管理员可访问全部功能，客服仅限查询与备注。
2. **单号查询页**
   - 单条输入：输入单号 -> 即时调用 Redis 缓存，未命中则走 17-track API 并写回。
   - 批量导入：上传 CSV/Excel（<=100 条）。
   - 列表展示：单号、承运商、最新状态、更新时间、备注、责任人。
3. **详情页**
   - 展示完整物流轨迹、历史状态。
   - 异常标签：待处理、处理中、已解决。
   - 备注记录：支持 Markdown 简文本，记录创建人+时间。
4. **异常管理**
   - 列表过滤（状态、责任人、时间）。
   - 支持导出 CSV。
5. **刷新策略**
   - 手动刷新：单号详情页点击刷新，触发异步任务（队列 + Redis 去重）。
   - 自动刷新：管理员可配置刷新频率（分钟/小时）和最大重试次数。

## 5. 非功能需求
- **性能**：单号查询响应 < 2s（缓存命中），API 调用链路需带超时与重试。
- **可靠性**：Redis 缓存命中率 > 70%，数据库主从或定期备份。
- **审计**：记录关键操作日志（登录、刷新、状态变更）。
- **安全**：仅内网访问，支持 HTTPS 反向代理。

## 6. 技术实现要点
- **后端**：Java 17 + Spring Boot 3，整合 17-track SDK/HTTP API。
- **数据库**：MySQL 8 存储单号、轨迹摘要、异常记录；必要索引：单号、更新时间。
- **缓存**：Redis 存最新状态与刷新锁；设置 TTL (默认 30 min)。
- **异步任务**：使用 Spring Scheduler + 队列（如 Redis Stream）驱动刷新。
- **接口封装**：提供 RESTful API，未来可供前端/第三方调用。

## 7. 成功指标
- 客服平均查单时间 < 30 秒。
- 95% 的查询返回最新 24h 内同步的状态。
- MVP 上线 1 周内无 P1 级故障。

## 8. 里程碑
| 阶段 | 时间 | 交付物 |
| --- | --- | --- |
| 需求冻结 | 第 1 天 | PRD、接口草图、数据模型 | 
| 开发迭代 | 第 2-7 天 | 查询接口、接入接口、刷新任务 | 
| 集成与验收 | 第 8-10 天 | 性能压测、对接联调 | 
| 上线 | 第 11-12 天 | 部署脚本、监控与告警 | 
| 需求冻结 | 第 1 天 | PRD、用户故事、原型草图 |
| 开发迭代 | 第 2-9 天 | 功能开发、联调、单元测试 |
| 联调与验收 | 第 10-12 天 | UAT、性能测试、BUG 修复 |
| 上线 | 第 13-14 天 | 预发布、正式上线 |

