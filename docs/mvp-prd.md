# 17-track 查询微服务 MVP PRD

## 1. 背景与目标
跨境业务系统需要一个可以直接复用的 17-track 查询微服务，以便不同系统在不关注底层 API 的情况下查询运单、获取状态更新并接收外部推送。MVP 目标是在最短时间内提供一个可部署的 Java 微服务，使用 MySQL + Redis 存储/缓存轨迹数据，开放标准 REST API 供其他系统调用，无需任何登录或权限模块。

## 2. 业务范围
- **单号查询**：对外提供按单号查询的 REST 接口，聚合 Redis 缓存和 17-track 实时结果。
- **状态监听与更新**：周期性刷新存量单号，并将最新状态落库、写缓存和触发消息通知。
- **运单号接入**：支持外部系统通过接口上传单号，以及监听外部推送（webhook）将单号写入处理队列。
- **接口暴露**：所有能力通过 REST API 或 webhook 注册完成，确保其他微服务可快速集成。

不包含：后台页面、账号系统、复杂任务编排、报表分析。

## 3. 主要使用者
- **对接系统开发者**：调用查询接口或上传单号，不需要了解 17-track API 细节。
- **运维/平台服务**：配置刷新频率、查看健康状况，确保刷新任务稳定执行。

## 4. 功能需求
1. **查询接口**
   - `GET /api/trackings/{trackingNo}` 返回最新状态、更新时间、轨迹摘要。
   - 支持批量查询 `POST /api/trackings/query`（<= 50 条）。
   - 优先读 Redis 缓存，未命中则请求 17-track API，将结果写入 MySQL + Redis。
2. **单号接入**
   - `POST /api/trackings` 接收单号或批次（含来源字段），写入待刷新队列。
   - Webhook 监听端点 `POST /api/webhooks/17track` 校验签名后写队列。
   - 支持手动上传文件（CSV）并拆分入队，由调用方提供文件 URL。
3. **状态刷新**
   - 定时任务扫描待刷新单号，调用 17-track API 并更新 MySQL/Redis。
   - 去重锁：Redis 记录刷新中的单号，防止重复调用。
   - 状态变更后触发事件（例如 Kafka/Redis Stream）供下游消费。
4. **配置与监控**
   - 通过配置文件或 `application.yml` 设置 API Key、刷新频率、重试次数。
   - 暴露 `GET /actuator/health`、`/metrics` 供监控。

## 5. 非功能需求
- **性能**：缓存命中查询 < 500ms，直连 17-track < 3s（含重试）。
- **可靠性**：失败自动重试 3 次；刷新任务支持断点重跑。
- **可扩展性**：接口幂等、可水平扩展；Redis 用于分布式锁与缓存。
- **安全**：以 IP 白名单或网关层面控制访问，接口本身无需鉴权。

## 6. 技术实现要点
- **后端**：Java 17 + Spring Boot 3，使用 WebFlux/RestTemplate 调用 17-track API。
- **数据库**：MySQL 8 存储单号、最新状态、轨迹摘要、刷新时间；关键索引：tracking_no、updated_at。
- **缓存**：Redis 保存最新状态 JSON、刷新锁以及待处理队列（List/Stream）。
- **异步处理**：Spring Scheduler + TaskExecutor，必要时集成消息队列以通知下游。
- **接口契约**：使用 OpenAPI 3 描述，方便其他系统生成 SDK。

## 7. 成功指标
- 95% 查询命中缓存或最近 10 分钟内刷新结果。
- 单号接入后 5 分钟内完成首轮状态拉取。
- 服务上线首周无 P1 故障，刷新任务成功率 ≥ 99%。

## 8. 里程碑
| 阶段 | 时间 | 交付物 |
| --- | --- | --- |
| 需求冻结 | 第 1 天 | PRD、接口草图、数据模型 | 
| 开发迭代 | 第 2-7 天 | 查询接口、接入接口、刷新任务 | 
| 集成与验收 | 第 8-10 天 | 性能压测、对接联调 | 
| 上线 | 第 11-12 天 | 部署脚本、监控与告警 | 
